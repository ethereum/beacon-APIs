get:
  tags:
    - Validator
    - ValidatorRequiredApi
  operationId: "produceBlockV4"
  summary: "Produce a new block, without signature."
  description: |
    Requests a beacon node to produce a valid block, which can then be signed by a validator.

    Post-Gloas, proposers submit execution payload bids rather than full execution payloads,
    so there is no longer a concept of blinded or unblinded blocks. Builders release the
    payload later. This endpoint is specific to the post-Gloas forks and is not backwards compatible
    with previous forks.

    When self-building (local execution payload), the response will include the full block contents
    including the beacon block, execution payload envelope, blobs, and KZG proofs.
    When using an external builder bid, only the `BeaconBlock` is returned as the beacon node
    does not have access to the builder's execution payload.

    The `Eth-Execution-Payload-Included` header and `execution_payload_included` response field
    indicate which response type was returned.
  parameters:
    - name: slot
      in: path
      required: true
      description: "The slot for which the block should be proposed."
      schema:
        $ref: "../../beacon-node-oapi.yaml#/components/schemas/Uint64"
    - name: randao_reveal
      in: query
      required: true
      description: "The validator's randao reveal value."
      schema:
        $ref: '../../beacon-node-oapi.yaml#/components/schemas/Signature'
    - name: graffiti
      in: query
      required: false
      description: "Arbitrary data validator wants to include in block."
      schema:
        $ref: '../../beacon-node-oapi.yaml#/components/schemas/Graffiti'
    - name: skip_randao_verification
      $ref: '../../beacon-node-oapi.yaml#/components/parameters/SkipRandaoVerification'
    - name: include_payload
      in: query
      required: false
      description: |
        Controls whether the execution payload envelope and blobs are included in the response
        when self-building (using local execution payload).

        When `true` (default), the response includes the full block contents: beacon block,
        execution payload envelope, blobs, and KZG proofs. This enables stateless operation
        where the validator client can use multiple beacon nodes (multi-BN setups, DVs, failover).

        When `false`, only the beacon block is returned and the beacon node caches the execution
        payload envelope and blobs internally. The validator client must then fetch them separately
        via `GET /eth/v1/validator/execution_payload_envelope/{slot}`. This saves
        bandwidth but requires the validator client to publish via the same beacon node that
        produced the block (stateful operation).

        This parameter only affects self-building scenarios. When using an external builder's bid,
        only the beacon block is returned regardless of this parameter (the beacon node does not
        have access to the builder's execution payload).
      schema:
        type: boolean
        default: true
    - name: builder_boost_factor
      in: query
      required: false
      description: |
        Percentage multiplier to apply to the builder's payload value when choosing between a
        builder payload header and payload from the paired execution node. This parameter is only
        relevant if the beacon node is connected to a builder, deems it safe to produce a builder
        payload, and receives valid responses from both the builder endpoint _and_ the paired
        execution node. When these preconditions are met, the server MUST act as follows:

        * if `exec_node_payload_value >= builder_boost_factor * (builder_payload_value // 100)`,
          then return a full (unblinded) block containing the execution node payload.
        * otherwise, return a blinded block containing the builder payload header.

        Servers must support the following values of the boost factor which encode common
        preferences:

        * `builder_boost_factor=0`: prefer the local execution node payload unless an error makes it
          unviable.
        * `builder_boost_factor=100`: profit maximization mode; choose whichever
          payload pays more.
        * `builder_boost_factor=2**64 - 1`: prefer the external builder payload unless an error or
          beacon node health check makes it unviable.

        Servers should use saturating arithmetic or another technique to ensure that large values of
        the `builder_boost_factor` do not trigger overflows or errors. If this parameter is
        provided and the beacon node is not configured with a builder then the beacon node MUST
        respond with a full block, which the caller can choose to reject if it wishes.
        If the value is provided but out of range for a 64-bit unsigned integer, then an error
        response with status code 400 MUST be returned.
      schema:
        $ref: "../../beacon-node-oapi.yaml#/components/schemas/Uint64"
  responses:
    "200":
      description: Success response
      headers:
        Eth-Consensus-Version:
          $ref: '../../beacon-node-oapi.yaml#/components/headers/Eth-Consensus-Version'
        Eth-Consensus-Block-Value:
          $ref: '../../beacon-node-oapi.yaml#/components/headers/Eth-Consensus-Block-Value'
        Eth-Execution-Payload-Included:
          $ref: '../../beacon-node-oapi.yaml#/components/headers/Eth-Execution-Payload-Included'
      content:
        application/json:
          schema:
            title: "ProduceBlockV4Response"
            type: object
            required: [version, consensus_block_value, execution_payload_included, data]
            properties:
              version:
                type: string
                enum: [gloas]
                example: "gloas"
              consensus_block_value:
                type: string
                example: "12345"
                description: "Consensus rewards for this block in Wei"
              execution_payload_included:
                type: boolean
                description: |
                  Indicates whether the execution payload envelope is included in the response.
                  When `true`, the `data` field contains the full
                  execution payload envelope, blobs, and KZG proofs. When `false`, the `data`
                  field contains only a `BeaconBlock`.
                example: false
              data:
                anyOf:
                  - $ref: "../../beacon-node-oapi.yaml#/components/schemas/Gloas.BeaconBlock"
                  - $ref: "../../beacon-node-oapi.yaml#/components/schemas/Gloas.BlockContents"
        application/octet-stream:
          schema:
            description: "SSZ serialized `BeaconBlock` or `BlockContents` bytes. Use Accept header to choose this response type, version string is sent in header `Eth-Consensus-Version` and payload inclusion indicated by `Eth-Execution-Payload-Included` header."
    "400":
      description: "Invalid block production request"
      content:
        application/json:
          schema:
            $ref: "../../beacon-node-oapi.yaml#/components/schemas/ErrorMessage"
          examples:
            InvalidRequest:
              value:
                code: 400
                message: "Invalid request to produce a block"
    "406":
      $ref: "../../beacon-node-oapi.yaml#/components/responses/NotAcceptable"
    "500":
      $ref: '../../beacon-node-oapi.yaml#/components/responses/InternalError'
    "503":
      $ref: '../../beacon-node-oapi.yaml#/components/responses/CurrentlySyncing'
